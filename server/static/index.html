<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiro API Client - Web æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { background-color: #3b82f6 !important; color: white !important; }
        .tab-button.active:hover { background-color: #2563eb !important; }
        .message { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .account-card { transition: all 0.2s ease; cursor: pointer; }
        .account-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59,130,246,0.15); }
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .model-card { transition: all 0.15s ease; }
        .model-card:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .privacy-mode .sensitive { filter: blur(6px); }
        /* ç†”æ–­çŠ¶æ€æ ‡ç­¾ */
        .cb-status-closed { background-color: #10B981; color: white; }
        .cb-status-open { background-color: #EF4444; color: white; }
        .cb-status-half-open { background-color: #F59E0B; color: white; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-robot text-3xl text-blue-600 mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-800">Kiro API Client</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="togglePrivacy()" class="text-gray-600 hover:text-blue-600 transition" title="åˆ‡æ¢éšç§æ¨¡å¼">
                        <i id="privacyIcon" class="fas fa-eye text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tab å¯¼èˆª -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b overflow-x-auto">
                <button class="tab-button active px-6 py-3 font-medium text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-tab="token">
                    <i class="fas fa-key mr-2"></i>Token ç®¡ç†
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-tab="chat">
                    <i class="fas fa-comments mr-2"></i>Chat èŠå¤©
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-tab="search">
                    <i class="fas fa-search mr-2"></i>Web Search
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-tab="mcp">
                    <i class="fas fa-tools mr-2"></i>MCP å·¥å…·
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-tab="mapping">
                    <i class="fas fa-exchange-alt mr-2"></i>æ¨¡å‹æ˜ å°„
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-tab="settings">
                    <i class="fas fa-cog mr-2"></i>API è®¾ç½®
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-tab="circuit-breaker">
                    <i class="fas fa-shield-alt mr-2"></i>ç†”æ–­ç®¡ç†
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-tab="charts">
                    <i class="fas fa-chart-pie mr-2"></i>ç»Ÿè®¡å›¾è¡¨
                </button>
            </div>
        </div>

        <!-- Token ç®¡ç†é¢æ¿ -->
        <div id="token" class="tab-content active">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-key text-blue-600 mr-2"></i>Token ç®¡ç†
                    </h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="startLogin()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                            <i class="fas fa-plus mr-2"></i>æ–°å¢è´¦å·
                        </button>
                        <button onclick="refreshTokenStatus()" class="text-blue-600 hover:text-blue-800 transition p-2" title="åˆ·æ–°çŠ¶æ€">
                            <i class="fas fa-sync-alt text-lg"></i>
                        </button>
                    </div>
                </div>
                <div id="accountsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- ç™»å½•å¼¹çª— -->
        <div id="loginModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                <h3 class="text-lg font-bold mb-4"><i class="fas fa-sign-in-alt text-blue-600 mr-2"></i>æ–°å¢è´¦å·</h3>
                <div id="loginContent">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç™»å½•ç±»å‹</label>
                        <div class="flex space-x-2">
                            <button type="button" onclick="setAuthType('BuilderId')" id="authTypeBuilderId" class="flex-1 px-4 py-2 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-medium transition">
                                <i class="fas fa-user mr-1"></i>ä¸ªäººè´¦å·
                            </button>
                            <button type="button" onclick="setAuthType('Enterprise')" id="authTypeEnterprise" class="flex-1 px-4 py-2 border-2 border-gray-300 text-gray-600 rounded-lg font-medium transition hover:border-gray-400">
                                <i class="fas fa-building mr-1"></i>ä¼ä¸šè´¦å·
                            </button>
                            <button type="button" onclick="setAuthType('Import')" id="authTypeImport" class="flex-1 px-4 py-2 border-2 border-gray-300 text-gray-600 rounded-lg font-medium transition hover:border-gray-400">
                                <i class="fas fa-file-import mr-1"></i>å¯¼å…¥Token
                            </button>
                        </div>
                        <p id="authTypeHint" class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle mr-1"></i>ä½¿ç”¨ AWS Builder ID ç™»å½•</p>
                    </div>
                    <div id="enterpriseUrlSection" class="mb-4 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¼ä¸š SSO URL</label>
                        <input type="text" id="enterpriseUrl" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="https://d-xxxxxxxx.awsapps.com/start">
                    </div>
                    <div id="importTokenSection" class="mb-4 hidden">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                            <p class="text-xs text-yellow-800"><i class="fas fa-info-circle mr-1"></i>Token æ–‡ä»¶è·¯å¾„: <code class="bg-yellow-100 px-1 rounded">~/.aws/sso/cache/kiro-auth-token.json</code></p>
                            <p class="text-xs text-yellow-800 mt-1"><i class="fas fa-info-circle mr-1"></i>ClientReg æ–‡ä»¶è·¯å¾„: <code class="bg-yellow-100 px-1 rounded">~/.aws/sso/cache/{clientIdHash}.json</code></p>
                        </div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Token JSON <span class="text-red-500">*</span></label>
                        <textarea id="importTokenJson" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-xs" placeholder='{
  "accessToken": "...",
  "refreshToken": "...",
  "expiresAt": "2025-02-04T12:00:00Z",
  "clientIdHash": "...",
  "authMethod": "BuilderId",
  "provider": "BuilderId",
  "region": "us-east-1"
}'></textarea>
                        <label class="block text-sm font-medium text-gray-700 mb-2 mt-3">ClientRegistration JSON <span class="text-gray-400">(ä¼ä¸šSSOå¿…å¡«)</span></label>
                        <textarea id="importClientRegJson" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-xs" placeholder='{
  "clientId": "...",
  "clientSecret": "..."
}'></textarea>
                    </div>
                    <div id="loginRegionSection" class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">åŒºåŸŸ</label>
                        <select id="loginRegion" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="us-east-1">ç¾å›½ä¸œéƒ¨ (us-east-1)</option>
                            <option value="eu-central-1">æ¬§æ´²ä¸­éƒ¨ (eu-central-1)</option>
                        </select>
                    </div>
                    <button id="loginActionBtn" onclick="doStartLogin()" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-external-link-alt mr-2"></i>å¼€å§‹ç™»å½•
                    </button>
                </div>
                <div id="loginPending" class="hidden text-center">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-600 mb-2">è¯·åœ¨æµè§ˆå™¨ä¸­å®Œæˆæˆæƒ</p>
                    <p class="text-sm text-gray-500 mb-2">ç”¨æˆ·ç : <span id="loginUserCode" class="font-mono font-bold text-blue-600"></span></p>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                        <p class="text-xs text-yellow-800 font-medium mb-2"><i class="fas fa-exclamation-triangle mr-1"></i>è¯·åœ¨éšç§çª—å£ä¸­æ‰“å¼€é“¾æ¥</p>
                        <button onclick="copyVerifyUrl()" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 rounded transition">
                            <i class="fas fa-copy mr-1"></i>å¤åˆ¶æˆæƒé“¾æ¥
                        </button>
                    </div>
                </div>
                <div id="loginSuccess" class="hidden text-center">
                    <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                    <p class="text-green-600 font-medium">ç™»å½•æˆåŠŸï¼</p>
                </div>
                <div id="loginError" class="hidden text-center">
                    <i class="fas fa-times-circle text-red-500 text-4xl mb-4"></i>
                    <p id="loginErrorMsg" class="text-red-600"></p>
                </div>
                <button onclick="closeLoginModal()" class="mt-4 w-full text-gray-600 hover:text-gray-800 transition text-sm">å…³é—­</button>
            </div>
        </div>

        <!-- è´¦å·è¯¦æƒ…å¼¹çª— -->
        <div id="accountDetailModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 overflow-y-auto">
            <div class="bg-white rounded-xl max-w-2xl w-full mx-4 my-8 shadow-2xl max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <div class="flex items-center space-x-2">
                                <span id="detailEmail" class="font-semibold text-gray-800 sensitive"></span>
                                <span id="detailSubBadge" class="px-2 py-0.5 bg-orange-500 text-white text-xs rounded font-medium"></span>
                            </div>
                            <div class="flex items-center space-x-2 text-sm text-gray-500">
                                <span id="detailProvider"></span>
                                <span>Â·</span>
                                <span>æ·»åŠ äº <span id="detailCreatedAt"></span></span>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeAccountDetail()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="p-6 space-y-6">
                    <!-- é…é¢æ€»è§ˆ -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-800"><i class="fas fa-chart-bar text-blue-500 mr-2"></i>é…é¢æ€»è§ˆ</h3>
                            <button onclick="refreshAccountDetail()" class="text-sm text-blue-600 hover:text-blue-800">
                                <i class="fas fa-sync-alt mr-1"></i>åˆ·æ–°æ•°æ®
                            </button>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-end justify-between mb-2">
                                <div>
                                    <span class="text-3xl font-bold text-gray-800" id="detailUsed">0</span>
                                    <span class="text-gray-500">/ <span id="detailTotal">0</span></span>
                                </div>
                                <span id="detailPercent" class="text-green-600 font-medium"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                                <div id="detailProgressBar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-white rounded-lg p-3 border">
                                    <div class="flex items-center text-sm text-blue-600 mb-1"><span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>ä¸»é…é¢</div>
                                    <div class="font-semibold"><span id="detailMainUsed">0</span><span class="text-gray-400 text-sm">/<span id="detailMainTotal">0</span></span></div>
                                </div>
                                <div class="bg-white rounded-lg p-3 border">
                                    <div class="flex items-center text-sm text-gray-500 mb-1"><span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>å…è´¹è¯•ç”¨</div>
                                    <div class="font-semibold text-gray-400"><span id="detailFreeUsed">0</span><span class="text-gray-300 text-sm">/<span id="detailFreeTotal">0</span></span></div>
                                </div>
                                <div class="bg-white rounded-lg p-3 border">
                                    <div class="flex items-center text-sm text-gray-500 mb-1"><span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>å¥–åŠ±æ€»è®¡</div>
                                    <div class="font-semibold text-gray-400"><span id="detailBonusUsed">0</span><span class="text-gray-300 text-sm">/<span id="detailBonusTotal">0</span></span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åŸºæœ¬ä¿¡æ¯ + è®¢é˜…è¯¦æƒ… -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-3"><i class="fas fa-user text-blue-500 mr-2"></i>åŸºæœ¬ä¿¡æ¯</h3>
                            <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                                <div>
                                    <div class="text-xs text-gray-500">é‚®ç®±/ID</div>
                                    <div id="detailEmailFull" class="font-medium text-gray-800 sensitive"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-xs text-gray-500">è´¦å·åˆ«å</div>
                                        <div id="detailAlias" class="font-medium text-gray-800">-</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500">èº«ä»½æä¾›å•†</div>
                                        <div id="detailProviderFull" class="font-medium text-gray-800"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">ç”¨æˆ· ID</div>
                                    <div id="detailUserId" class="font-mono text-sm bg-white border rounded p-2 break-all sensitive"></div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-3"><i class="fas fa-link text-blue-500 mr-2"></i>è®¢é˜…è¯¦æƒ…</h3>
                            <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                                <div class="flex justify-between"><span class="text-gray-500">Region</span><span id="detailRegion" class="font-mono bg-gray-200 px-2 py-0.5 rounded text-sm"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">Token åˆ°æœŸ</span><span id="detailTokenExpiry" class="text-gray-800"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">è®¢é˜…ç±»å‹</span><span id="detailSubType" class="text-gray-800">-</span></div>
                                <div class="flex justify-between"><span class="text-gray-500">è¶…é¢è´¹ç‡</span><span id="detailOverageRate" class="text-gray-800"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">èµ„æºç±»å‹</span><span id="detailResourceType" class="text-gray-800"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">å¯å‡çº§</span><span id="detailCanUpgrade" class="text-gray-800"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- å¯ç”¨æ¨¡å‹ -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800"><i class="fas fa-cube text-blue-500 mr-2"></i>è´¦æˆ·å¯ç”¨æ¨¡å‹</h3>
                            <span id="detailModelCount" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-sm font-medium"></span>
                        </div>
                        <div id="detailModelsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat èŠå¤©é¢æ¿ -->
        <div id="chat" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-comments text-blue-600 mr-2"></i>AI èŠå¤©</h2>
                <div class="mb-4 flex items-center space-x-4">
                    <label class="text-sm font-medium text-gray-700">æ¨¡å‹é€‰æ‹©:</label>
                    <select id="modelSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                <div id="chatMessages" class="h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg space-y-4">
                    <div class="text-center text-gray-500 py-8"><i class="fas fa-comment-dots text-4xl mb-2"></i><p>å¼€å§‹å¯¹è¯å§ï¼</p></div>
                </div>
                <div class="flex space-x-4">
                    <input type="text" id="chatInput" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') sendChat()">
                    <label class="flex items-center space-x-2"><input type="checkbox" id="streamMode" checked class="w-4 h-4"><span class="text-sm text-gray-700">æµå¼</span></label>
                    <button onclick="sendChat()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-paper-plane mr-2"></i>å‘é€</button>
                    <button onclick="clearChat()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition"><i class="fas fa-trash mr-2"></i>æ¸…ç©º</button>
                </div>
            </div>
        </div>

        <!-- Web Search é¢æ¿ -->
        <div id="search" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-search text-blue-600 mr-2"></i>Web æœç´¢</h2>
                <div class="flex space-x-4 mb-6">
                    <input type="text" id="searchQuery" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="è¾“å…¥æœç´¢å…³é”®è¯..." onkeypress="if(event.key==='Enter') performSearch()">
                    <input type="number" id="maxResults" value="10" min="1" max="50" class="w-24 px-4 py-2 border border-gray-300 rounded-lg" placeholder="æ•°é‡">
                    <button onclick="performSearch()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-search mr-2"></i>æœç´¢</button>
                </div>
                <div id="searchResults" class="space-y-4">
                    <div class="text-center text-gray-500 py-8"><i class="fas fa-search text-4xl mb-2"></i><p>è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</p></div>
                </div>
            </div>
        </div>

        <!-- MCP å·¥å…·é¢æ¿ -->
        <div id="mcp" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-tools text-blue-600 mr-2"></i>MCP å·¥å…·</h2>
                <div class="mb-6">
                    <button onclick="loadTools()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition mb-4"><i class="fas fa-sync-alt mr-2"></i>åŠ è½½å·¥å…·åˆ—è¡¨</button>
                    <div id="toolsList" class="space-y-2">
                        <div class="text-center text-gray-500 py-8"><i class="fas fa-tools text-4xl mb-2"></i><p>ç‚¹å‡»æŒ‰é’®åŠ è½½å¯ç”¨å·¥å…·</p></div>
                    </div>
                </div>
                <div id="toolCallSection" class="hidden">
                    <h3 class="text-lg font-semibold mb-3">è°ƒç”¨å·¥å…·</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">å·¥å…·åç§°</label><input type="text" id="toolName" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">å‚æ•° (JSON)</label><textarea id="toolArgs" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-sm" placeholder='{"query": "test"}'></textarea></div>
                        <button onclick="callTool()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition"><i class="fas fa-play mr-2"></i>æ‰§è¡Œ</button>
                    </div>
                    <div id="toolResult" class="mt-4 hidden"><h3 class="text-lg font-semibold mb-3">æ‰§è¡Œç»“æœ</h3><div class="p-4 bg-gray-50 rounded-lg"><pre id="toolResultContent" class="text-sm overflow-x-auto"></pre></div></div>
                </div>
            </div>
        </div>

        <!-- æ¨¡å‹æ˜ å°„é¢æ¿ -->
        <div id="mapping" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-exchange-alt text-blue-600 mr-2"></i>æ¨¡å‹æ˜ å°„é…ç½®</h2>
                <p class="text-gray-600 mb-4">é…ç½®å¤–éƒ¨æ¨¡å‹IDåˆ°Kiroå†…éƒ¨æ¨¡å‹IDçš„æ˜ å°„å…³ç³»</p>
                <div class="mb-4">
                    <button onclick="loadModelMapping(true)" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition mr-2"><i class="fas fa-sync-alt mr-2"></i>åŠ è½½é…ç½®</button>
                    <button onclick="saveModelMapping()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition mr-2"><i class="fas fa-save mr-2"></i>ä¿å­˜é…ç½®</button>
                    <button onclick="addMappingRow()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition"><i class="fas fa-plus mr-2"></i>æ·»åŠ æ˜ å°„</button>
                </div>
                <div id="mappingTable" class="space-y-2"></div>
            </div>
        </div>

        <!-- API è®¾ç½®é¢æ¿ -->
        <div id="settings" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-key text-blue-600 mr-2"></i>API-KEY è®¾ç½®</h2>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-blue-800"><i class="fas fa-info-circle mr-2"></i>é…ç½® API-KEY åï¼Œæ‰€æœ‰ OpenAI/Claude æ ¼å¼çš„è¯·æ±‚éƒ½éœ€è¦æºå¸¦æœ‰æ•ˆçš„ API-KEY æ‰èƒ½è®¿é—®ã€‚</p>
                    <p class="text-xs text-blue-600 mt-2">æ”¯æŒä¸¤ç§æ ¼å¼ï¼š</p>
                    <ul class="text-xs text-blue-600 mt-1 ml-4 list-disc">
                        <li>Claude æ ¼å¼: <code class="bg-blue-100 px-1 rounded">X-API-Key: sk-xxx</code></li>
                        <li>OpenAI æ ¼å¼: <code class="bg-blue-100 px-1 rounded">Authorization: Bearer sk-xxx</code></li>
                    </ul>
                </div>
                <div class="mb-4 flex space-x-2">
                    <button onclick="loadApiKeysConfig(true)" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-sync-alt mr-2"></i>åŠ è½½é…ç½®</button>
                    <button onclick="saveApiKeysConfig()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"><i class="fas fa-save mr-2"></i>ä¿å­˜é…ç½®</button>
                    <button onclick="addApiKeyRow()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition"><i class="fas fa-plus mr-2"></i>æ·»åŠ  KEY</button>
                    <button onclick="generateApiKey()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition"><i class="fas fa-magic mr-2"></i>ç”Ÿæˆéšæœº KEY</button>
                </div>
                <div id="apiKeysTable" class="space-y-2">
                    <div class="text-center text-gray-500 py-4">ç‚¹å‡»"åŠ è½½é…ç½®"æŸ¥çœ‹å½“å‰ API-KEY</div>
                </div>
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-medium text-gray-800 mb-2"><i class="fas fa-terminal mr-2"></i>æµ‹è¯•å‘½ä»¤</h3>
                    <p class="text-xs text-gray-500 mb-2">ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯• API-KEY æ˜¯å¦ç”Ÿæ•ˆï¼š</p>
                    <pre class="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto">curl http://localhost:8080/v1/chat/completions \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model":"auto","messages":[{"role":"user","content":"hi"}]}'</pre>
                </div>
            </div>

            <!-- é™æµé…ç½® -->
            <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-tachometer-alt text-orange-600 mr-2"></i>é™æµé…ç½®</h2>
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-orange-800"><i class="fas fa-info-circle mr-2"></i>é™åˆ¶æ¯ä¸ª IP æ¯åˆ†é’Ÿçš„è¯·æ±‚æ¬¡æ•°ï¼Œä»…å¯¹ /v1/* æ¥å£ç”Ÿæ•ˆã€‚</p>
                </div>
                <div class="flex items-center space-x-4 mb-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="rateLimitEnabled" class="w-5 h-5 text-orange-600">
                        <span class="font-medium">å¯ç”¨é™æµ</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-600">æ¯åˆ†é’Ÿæœ€å¤š</span>
                        <input type="number" id="rateLimitRpm" value="60" min="1" class="w-24 px-3 py-2 border rounded-lg">
                        <span class="text-gray-600">æ¬¡è¯·æ±‚</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-600">è¶…é™å»¶è¿Ÿ</span>
                        <input type="number" id="rateLimitPenalty" value="0" min="0" class="w-20 px-3 py-2 border rounded-lg">
                        <span class="text-gray-600">ç§’</span>
                    </div>
                    <button onclick="saveRateLimitConfig()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition"><i class="fas fa-save mr-2"></i>ä¿å­˜</button>
                </div>
            </div>

            <!-- IP é»‘åå• -->
            <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-ban text-red-600 mr-2"></i>IP é»‘åå•</h2>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-red-800"><i class="fas fa-info-circle mr-2"></i>é»‘åå•ä¸­çš„ IP å°†è¢«ç¦æ­¢è®¿é—®æ‰€æœ‰æ¥å£ã€‚</p>
                </div>
                <div class="mb-4 flex space-x-2">
                    <button onclick="loadIpBlacklist(true)" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-sync-alt mr-2"></i>åŠ è½½</button>
                    <button onclick="saveIpBlacklist()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"><i class="fas fa-save mr-2"></i>ä¿å­˜</button>
                    <button onclick="addIpRow()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition"><i class="fas fa-plus mr-2"></i>æ·»åŠ  IP</button>
                </div>
                <div id="ipBlacklistTable" class="space-y-2">
                    <div class="text-center text-gray-500 py-4">ç‚¹å‡»"åŠ è½½"æŸ¥çœ‹å½“å‰é»‘åå•</div>
                </div>
            </div>

            <!-- ç³»ç»Ÿé€šçŸ¥é…ç½® -->
            <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-bell text-yellow-500 mr-2"></i>ç³»ç»Ÿé€šçŸ¥</h2>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-yellow-800"><i class="fas fa-info-circle mr-2"></i>å¯ç”¨åï¼ŒAI å›å¤æœ«å°¾ä¼šè‡ªåŠ¨è¿½åŠ é€šçŸ¥å†…å®¹ï¼ˆæ”¯æŒ Markdownï¼‰ã€‚å®¢æˆ·ç«¯å›ä¼ æ—¶ä¼šè‡ªåŠ¨è¿‡æ»¤é€šçŸ¥ï¼Œé¿å… AI è¯¯è§£ã€‚</p>
                </div>
                <div class="flex items-center space-x-4 mb-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="notificationEnabled" class="w-5 h-5 text-yellow-600">
                        <span class="font-medium">å¯ç”¨é€šçŸ¥</span>
                    </label>
                    <button onclick="loadNotificationConfig(true)" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-sync-alt mr-2"></i>åŠ è½½</button>
                    <button onclick="saveNotificationConfig()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"><i class="fas fa-save mr-2"></i>ä¿å­˜</button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é€šçŸ¥å†…å®¹ï¼ˆMarkdownï¼‰</label>
                    <textarea id="notificationMessage" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm" placeholder=">            &#10;### ğŸ“£ ç½‘ç«™é€šçŸ¥&#10;>            &#10;>            åœ¨è¿™é‡Œè¾“å…¥é€šçŸ¥å†…å®¹..."></textarea>
                </div>
            </div>
        </div>

        <!-- ç†”æ–­ç®¡ç†é¢æ¿ -->
        <div id="circuit-breaker" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-shield-alt text-blue-600 mr-2"></i>ç†”æ–­ç®¡ç†
                    </h2>
                    <button onclick="loadCircuitBreakerStatus()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°
                    </button>
                </div>
                <div id="circuit-breaker-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="col-span-3 text-center text-gray-500 py-8">
                        <i class="fas fa-shield-alt text-4xl mb-2"></i>
                        <p>åˆ‡æ¢åˆ°æ­¤ Tab æ—¶è‡ªåŠ¨åŠ è½½ç†”æ–­çŠ¶æ€</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡å›¾è¡¨é¢æ¿ -->
        <div id="charts" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-chart-pie text-purple-600 mr-2"></i>è´¦å·è°ƒç”¨ç»Ÿè®¡<span id="totalRequestsCount" class="text-gray-500 font-normal ml-2"></span>
                    </h2>
                    <button onclick="loadAccountStats()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°æ•°æ®
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-700 mb-4"><i class="fas fa-percentage text-blue-500 mr-2"></i>è°ƒç”¨æ¬¡æ•°å æ¯”</h3>
                        <div id="requestPieChart" class="h-64 flex items-center justify-center">
                            <div class="text-gray-500">ç‚¹å‡»åˆ·æ–°åŠ è½½æ•°æ®</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-700 mb-4"><i class="fas fa-list-ol text-green-500 mr-2"></i>è°ƒç”¨æ¬¡æ•°æ’è¡Œ</h3>
                        <div id="requestRankList" class="space-y-2">
                            <div class="text-center text-gray-500 py-8">ç‚¹å‡»åˆ·æ–°åŠ è½½æ•°æ®</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-exclamation-triangle text-orange-600 mr-2"></i>çŠ¶æ€ç ä¸é”™è¯¯åˆ†å¸ƒ
                </h2>
                <div id="accountErrorList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">ç‚¹å‡»åˆ·æ–°åŠ è½½æ•°æ®</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="hidden fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all"></div>

    <script>
        // å…¨å±€çŠ¶æ€
        let privacyMode = false;
        let currentLoginSession = null;
        let loginPollTimer = null;
        let chatHistory = [];
        let currentDetailAccountId = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            loadAccounts();
            loadModels();
            loadApiKeysConfig();  // è‡ªåŠ¨åŠ è½½ API-KEY é…ç½®
            loadRateLimitConfig(); // è‡ªåŠ¨åŠ è½½é™æµé…ç½®
            loadIpBlacklist();    // è‡ªåŠ¨åŠ è½½ IP é»‘åå•
            loadModelMapping();   // è‡ªåŠ¨åŠ è½½æ¨¡å‹æ˜ å°„é…ç½®
            loadNotificationConfig(); // è‡ªåŠ¨åŠ è½½é€šçŸ¥é…ç½®
            
            // ä»URL Hashæ¢å¤TabçŠ¶æ€
            restoreTabFromHash();
            
            // ç›‘å¬æµè§ˆå™¨å‰è¿›/åé€€æŒ‰é’®
            window.addEventListener('hashchange', restoreTabFromHash);
        });

        // Tab åˆ‡æ¢
        function initTabs() {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchToTab(btn.dataset.tab);
                });
            });
        }
        
        // åˆ‡æ¢åˆ°æŒ‡å®šTab
        function switchToTab(tabId) {
            // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // æ¿€æ´»ç›®æ ‡Tab
            const targetBtn = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            const targetContent = document.getElementById(tabId);
            
            if (targetBtn && targetContent) {
                targetBtn.classList.add('active');
                targetContent.classList.add('active');
                
                // æ›´æ–°URL Hashï¼ˆä¸è§¦å‘é¡µé¢è·³è½¬ï¼‰
                history.replaceState(null, '', `#${tabId}`);
                
                // åˆ‡æ¢åˆ°ç»Ÿè®¡å›¾è¡¨ Tab æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
                if (tabId === 'charts') {
                    loadAccountStats();
                }
                
                // ç†”æ–­ç®¡ç† Tabï¼šè¿›å…¥æ—¶å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼Œç¦»å¼€æ—¶åœæ­¢
                if (tabId === 'circuit-breaker') {
                    loadCircuitBreakerStatus();
                    startCBAutoRefresh();
                } else {
                    stopCBAutoRefresh();
                }
            }
        }
        
        // ä»URL Hashæ¢å¤TabçŠ¶æ€
        function restoreTabFromHash() {
            // è·å–URL Hashï¼ˆå»æ‰#å·ï¼‰
            const hash = window.location.hash.substring(1);
            
            if (hash) {
                // éªŒè¯Tabæ˜¯å¦å­˜åœ¨
                const targetBtn = document.querySelector(`.tab-button[data-tab="${hash}"]`);
                if (targetBtn) {
                    // å…ˆç§»é™¤é»˜è®¤çš„activeçŠ¶æ€
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // åˆ‡æ¢åˆ°HashæŒ‡å®šçš„Tabï¼ˆä¸æ›´æ–°URLï¼Œé¿å…å¾ªç¯ï¼‰
                    targetBtn.classList.add('active');
                    document.getElementById(hash).classList.add('active');
                    
                    // è§¦å‘ç‰¹æ®ŠTabçš„åŠ è½½é€»è¾‘
                    if (hash === 'charts') {
                        loadAccountStats();
                    }
                    if (hash === 'circuit-breaker') {
                        loadCircuitBreakerStatus();
                        startCBAutoRefresh();
                    } else {
                        stopCBAutoRefresh();
                    }
                }
            }
        }

        // Toast é€šçŸ¥
        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all';
            if (type === 'success') toast.classList.add('bg-green-500', 'text-white');
            else if (type === 'error') toast.classList.add('bg-red-500', 'text-white');
            else toast.classList.add('bg-blue-500', 'text-white');
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // éšç§æ¨¡å¼
        function togglePrivacy() {
            privacyMode = !privacyMode;
            document.body.classList.toggle('privacy-mode', privacyMode);
            document.getElementById('privacyIcon').className = privacyMode ? 'fas fa-eye-slash text-xl' : 'fas fa-eye text-xl';
            showToast(privacyMode ? 'éšç§æ¨¡å¼å·²å¼€å¯' : 'éšç§æ¨¡å¼å·²å…³é—­');
        }

        // ========== ç™»å½•æµç¨‹ ==========
        let currentAuthType = 'BuilderId';

        function startLogin() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginContent').classList.remove('hidden');
            document.getElementById('loginPending').classList.add('hidden');
            document.getElementById('loginSuccess').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
            setAuthType('BuilderId');
        }

        function setAuthType(type) {
            currentAuthType = type;
            const builderBtn = document.getElementById('authTypeBuilderId');
            const enterpriseBtn = document.getElementById('authTypeEnterprise');
            const importBtn = document.getElementById('authTypeImport');
            const enterpriseSection = document.getElementById('enterpriseUrlSection');
            const importSection = document.getElementById('importTokenSection');
            const regionSection = document.getElementById('loginRegionSection');
            const hint = document.getElementById('authTypeHint');
            const actionBtn = document.getElementById('loginActionBtn');
            // é‡ç½®æ‰€æœ‰æŒ‰é’®æ ·å¼
            builderBtn.className = 'flex-1 px-4 py-2 border-2 border-gray-300 text-gray-600 rounded-lg font-medium transition hover:border-gray-400';
            enterpriseBtn.className = 'flex-1 px-4 py-2 border-2 border-gray-300 text-gray-600 rounded-lg font-medium transition hover:border-gray-400';
            importBtn.className = 'flex-1 px-4 py-2 border-2 border-gray-300 text-gray-600 rounded-lg font-medium transition hover:border-gray-400';
            enterpriseSection.classList.add('hidden');
            importSection.classList.add('hidden');
            regionSection.classList.remove('hidden');
            if (type === 'BuilderId') {
                builderBtn.className = 'flex-1 px-4 py-2 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-medium transition';
                hint.innerHTML = '<i class="fas fa-info-circle mr-1"></i>ä½¿ç”¨ AWS Builder ID ç™»å½•';
                actionBtn.innerHTML = '<i class="fas fa-external-link-alt mr-2"></i>å¼€å§‹ç™»å½•';
                actionBtn.onclick = doStartLogin;
            } else if (type === 'Enterprise') {
                enterpriseBtn.className = 'flex-1 px-4 py-2 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-medium transition';
                enterpriseSection.classList.remove('hidden');
                hint.innerHTML = '<i class="fas fa-info-circle mr-1"></i>ä½¿ç”¨ä¼ä¸š IAM Identity Center ç™»å½•';
                actionBtn.innerHTML = '<i class="fas fa-external-link-alt mr-2"></i>å¼€å§‹ç™»å½•';
                actionBtn.onclick = doStartLogin;
            } else if (type === 'Import') {
                importBtn.className = 'flex-1 px-4 py-2 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-medium transition';
                importSection.classList.remove('hidden');
                regionSection.classList.add('hidden');
                hint.innerHTML = '<i class="fas fa-info-circle mr-1"></i>ç›´æ¥å¯¼å…¥å·²æœ‰çš„ Token JSONï¼ˆé€‚ç”¨äºä¼ä¸š SSO æˆ–æ‰‹åŠ¨è¿ç§»ï¼‰';
                actionBtn.innerHTML = '<i class="fas fa-file-import mr-2"></i>å¯¼å…¥è´¦å·';
                actionBtn.onclick = doImportToken;
            }
        }

        async function doImportToken() {
            const tokenJson = document.getElementById('importTokenJson').value.trim();
            const clientRegJson = document.getElementById('importClientRegJson').value.trim();
            if (!tokenJson) { showToast('è¯·è¾“å…¥ Token JSON', 'error'); return; }
            // éªŒè¯ JSON æ ¼å¼
            try { JSON.parse(tokenJson); } catch (e) { showToast('Token JSON æ ¼å¼é”™è¯¯: ' + e.message, 'error'); return; }
            if (clientRegJson) {
                try { JSON.parse(clientRegJson); } catch (e) { showToast('ClientRegistration JSON æ ¼å¼é”™è¯¯: ' + e.message, 'error'); return; }
            }
            try {
                const resp = await fetch('/api/auth/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tokenJson, clientRegJson })
                });
                const data = await resp.json();
                if (data.error) { showToast(data.error, 'error'); return; }
                document.getElementById('loginContent').classList.add('hidden');
                document.getElementById('loginSuccess').classList.remove('hidden');
                showToast('è´¦å·å¯¼å…¥æˆåŠŸï¼', 'success');
                setTimeout(() => { closeLoginModal(); location.reload(); }, 1500);
            } catch (e) { showToast('å¯¼å…¥å¤±è´¥: ' + e.message, 'error'); }
        }

        async function doStartLogin() {
            const region = document.getElementById('loginRegion').value;
            let startUrl = '';
            if (currentAuthType === 'Enterprise') {
                startUrl = document.getElementById('enterpriseUrl').value.trim();
                if (!startUrl) { showToast('è¯·è¾“å…¥ä¼ä¸š SSO URL', 'error'); return; }
            }
            try {
                const resp = await fetch('/api/auth/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ region, startUrl })
                });
                const data = await resp.json();
                if (data.error) { showToast(data.error, 'error'); return; }
                currentLoginSession = data;
                document.getElementById('loginContent').classList.add('hidden');
                document.getElementById('loginPending').classList.remove('hidden');
                document.getElementById('loginUserCode').textContent = data.userCode;
                startLoginPolling(data.sessionId);
            } catch (e) { showToast('å¯åŠ¨ç™»å½•å¤±è´¥: ' + e.message, 'error'); }
        }

        function startLoginPolling(sessionId) {
            if (loginPollTimer) clearInterval(loginPollTimer);
            loginPollTimer = setInterval(async () => {
                try {
                    const resp = await fetch(`/api/auth/poll/${sessionId}`);
                    const data = await resp.json();
                    if (data.status === 'success') {
                        clearInterval(loginPollTimer);
                        document.getElementById('loginPending').classList.add('hidden');
                        document.getElementById('loginSuccess').classList.remove('hidden');
                        showToast('ç™»å½•æˆåŠŸï¼', 'success');
                        setTimeout(() => { closeLoginModal(); location.reload(); }, 1500);
                    } else if (data.error) {
                        clearInterval(loginPollTimer);
                        document.getElementById('loginPending').classList.add('hidden');
                        document.getElementById('loginError').classList.remove('hidden');
                        document.getElementById('loginErrorMsg').textContent = data.error;
                    }
                } catch (e) { console.error('è½®è¯¢å¤±è´¥:', e); }
            }, 3000);
        }

        function copyVerifyUrl() {
            if (!currentLoginSession || !currentLoginSession.verifyUrl) {
                showToast('æˆæƒé“¾æ¥ä¸å¯ç”¨', 'error');
                return;
            }
            const url = currentLoginSession.verifyUrl;
            // navigator.clipboard åœ¨ HTTP ä¸‹ä¸å¯ç”¨ï¼Œç”¨ fallback
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {
                    showToast('æˆæƒé“¾æ¥å·²å¤åˆ¶', 'success');
                }).catch(() => {
                    fallbackCopy(url, 'æˆæƒé“¾æ¥å·²å¤åˆ¶');
                });
            } else {
                fallbackCopy(url, 'æˆæƒé“¾æ¥å·²å¤åˆ¶');
            }
        }

        function fallbackCopy(text, successMsg) {
            const msg = successMsg || 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                showToast(msg, 'success');
            } catch (e) {
                prompt('è¯·æ‰‹åŠ¨å¤åˆ¶:', text);
            }
            document.body.removeChild(ta);
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            if (loginPollTimer) { clearInterval(loginPollTimer); loginPollTimer = null; }
            currentLoginSession = null;
        }

        // ========== è´¦å·ç®¡ç† ==========
        async function loadAccounts() {
            try {
                const resp = await fetch('/api/accounts');
                const data = await resp.json();
                renderAccounts(data.accounts || []);
            } catch (e) { showToast('åŠ è½½è´¦å·å¤±è´¥: ' + e.message, 'error'); }
        }

        // æ ¼å¼åŒ–ç”¨æˆ·IDæ˜¾ç¤ºï¼ˆæå–é‚®ç®±æˆ–ç®€çŸ­IDï¼‰
        function formatUserId(acc) {
            // ä¼˜å…ˆæ˜¾ç¤ºé‚®ç®±
            if (acc.email && acc.email.trim()) return acc.email;
            // å¦‚æœæœ‰ userIdï¼Œæå– UUID éƒ¨åˆ†ï¼ˆå»æ‰ d-xxxxxxxx. å‰ç¼€ï¼‰
            if (acc.userId) {
                const parts = acc.userId.split('.');
                if (parts.length === 2) return parts[1]; // åªæ˜¾ç¤º UUID éƒ¨åˆ†
                return acc.userId;
            }
            // æœ€åä½¿ç”¨ ID çš„å‰8ä½
            return acc.id ? acc.id.substring(0, 8) : 'æœªçŸ¥';
        }

        function renderAccounts(accounts) {
            const grid = document.getElementById('accountsGrid');
            if (!accounts || accounts.length === 0) {
                grid.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-8"><i class="fas fa-user-plus text-4xl mb-2"></i><p>æš‚æ— è´¦å·ï¼Œç‚¹å‡»"æ–°å¢è´¦å·"æ·»åŠ </p></div>';
                return;
            }
            // æŒ‰è´¦å·åç§°æ’åºï¼ˆ0-9ï¼ŒA-Zï¼‰
            const sorted = [...accounts].sort((a, b) => {
                const nameA = formatUserId(a).toLowerCase();
                const nameB = formatUserId(b).toLowerCase();
                return nameA.localeCompare(nameB, 'en', { numeric: true });
            });
            grid.innerHTML = sorted.map(acc => {
                const usedPct = acc.totalCredits > 0 ? Math.round((acc.usedCredits / acc.totalCredits) * 100) : 0;
                const remaining = acc.totalCredits - acc.usedCredits;
                const isExpired = acc.token && acc.token.isExpired;
                const subName = acc.subscriptionName || 'FREE';
                const badgeColor = subName === 'POWER' ? 'bg-orange-500' : 'bg-gray-500';
                const email = formatUserId(acc);
                return `
                <div class="account-card bg-white border rounded-xl p-4 hover:shadow-lg" onclick="showAccountDetail('${acc.id}')">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-blue-600"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800 sensitive">${email}</div>
                                <span class="px-2 py-0.5 ${badgeColor} text-white text-xs rounded font-medium">KIRO ${subName}</span>
                            </div>
                        </div>
                        <div class="flex space-x-1" onclick="event.stopPropagation()">
                            <button onclick="refreshAccount('${acc.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded" title="åˆ·æ–°Token"><i class="fas fa-sync-alt"></i></button>
                            <button onclick="deleteAccount('${acc.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-500">å·²ç”¨ ${acc.usedCredits.toFixed(1)} / ${acc.totalCredits.toFixed(0)}</span>
                            <span class="text-gray-600">${usedPct}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full transition-all ${usedPct > 80 ? 'bg-red-500' : usedPct > 50 ? 'bg-yellow-500' : 'bg-blue-500'}" style="width: ${usedPct}%"></div>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500"><i class="fas fa-calendar mr-1"></i>${acc.daysUntilReset || 0} å¤©åé‡ç½®</span>
                        <span class="${isExpired ? 'text-red-500' : acc.tokenMinutesLeft < 30 ? 'text-yellow-500' : 'text-green-500'}"><i class="fas fa-${isExpired ? 'times-circle' : 'clock'} mr-1"></i>${isExpired ? 'Token å·²è¿‡æœŸ' : acc.tokenMinutesLeft + ' åˆ†é’Ÿ'}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function refreshTokenStatus() { loadAccounts(); showToast('æ­£åœ¨åˆ·æ–°...'); }

        async function deleteAccount(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è´¦å·å—ï¼Ÿ')) return;
            try {
                const resp = await fetch(`/api/accounts/${id}`, { method: 'DELETE' });
                const data = await resp.json();
                if (data.error) { showToast(data.error, 'error'); return; }
                showToast('è´¦å·å·²åˆ é™¤', 'success');
                loadAccounts();
            } catch (e) { showToast('åˆ é™¤å¤±è´¥: ' + e.message, 'error'); }
        }

        async function refreshAccount(id) {
            try {
                showToast('æ­£åœ¨åˆ·æ–° Token...');
                const resp = await fetch(`/api/accounts/${id}/refresh`, { method: 'POST' });
                const data = await resp.json();
                if (data.error) { showToast(data.error, 'error'); return; }
                showToast('Token å·²åˆ·æ–°', 'success');
                loadAccounts();
            } catch (e) { showToast('åˆ·æ–°å¤±è´¥: ' + e.message, 'error'); }
        }

        // ========== è´¦å·è¯¦æƒ…å¼¹çª— ==========
        async function showAccountDetail(accountId) {
            currentDetailAccountId = accountId;
            document.getElementById('accountDetailModal').classList.remove('hidden');
            try {
                const resp = await fetch(`/api/accounts/${accountId}/detail`);
                const data = await resp.json();
                if (data.error) { showToast(data.error, 'error'); return; }
                renderAccountDetail(data);
            } catch (e) { showToast('åŠ è½½è¯¦æƒ…å¤±è´¥: ' + e.message, 'error'); }
        }

        function closeAccountDetail() {
            document.getElementById('accountDetailModal').classList.add('hidden');
            currentDetailAccountId = null;
        }

        async function refreshAccountDetail() {
            if (currentDetailAccountId) {
                showToast('æ­£åœ¨åˆ·æ–°...');
                await showAccountDetail(currentDetailAccountId);
            }
        }

        function renderAccountDetail(data) {
            const displayName = formatUserId(data);
            const subName = data.subscriptionName || 'FREE';
            const badgeColor = subName === 'POWER' ? 'bg-orange-500' : 'bg-gray-500';
            document.getElementById('detailEmail').textContent = displayName;
            document.getElementById('detailSubBadge').textContent = 'KIRO ' + subName;
            document.getElementById('detailSubBadge').className = `px-2 py-0.5 ${badgeColor} text-white text-xs rounded font-medium`;
            document.getElementById('detailProvider').textContent = data.provider || 'BuilderId';
            document.getElementById('detailCreatedAt').textContent = data.createdAt ? data.createdAt.split('T')[0] : '-';
            // é…é¢
            const usedPct = data.totalCredits > 0 ? Math.round((data.usedCredits / data.totalCredits) * 100) : 0;
            document.getElementById('detailUsed').textContent = data.usedCredits.toFixed(1);
            document.getElementById('detailTotal').textContent = data.totalCredits.toFixed(0);
            document.getElementById('detailPercent').textContent = `å‰©ä½™ ${(data.totalCredits - data.usedCredits).toFixed(1)}`;
            document.getElementById('detailProgressBar').style.width = usedPct + '%';
            document.getElementById('detailMainUsed').textContent = data.mainQuota ? data.mainQuota.used.toFixed(1) : '0';
            document.getElementById('detailMainTotal').textContent = data.mainQuota ? data.mainQuota.total.toFixed(0) : '0';
            document.getElementById('detailFreeUsed').textContent = data.freeQuota ? data.freeQuota.used.toFixed(1) : '0';
            document.getElementById('detailFreeTotal').textContent = data.freeQuota ? data.freeQuota.total.toFixed(0) : '0';
            document.getElementById('detailBonusUsed').textContent = data.bonusQuota ? data.bonusQuota.used.toFixed(1) : '0';
            document.getElementById('detailBonusTotal').textContent = data.bonusQuota ? data.bonusQuota.total.toFixed(0) : '0';
            // åŸºæœ¬ä¿¡æ¯
            document.getElementById('detailEmailFull').textContent = displayName;
            document.getElementById('detailAlias').textContent = '-';
            document.getElementById('detailProviderFull').textContent = data.provider || 'BuilderId';
            document.getElementById('detailUserId').textContent = data.userId || '-';
            // è®¢é˜…è¯¦æƒ…
            document.getElementById('detailRegion').textContent = data.region || 'us-east-1';
            document.getElementById('detailTokenExpiry').textContent = data.tokenExpiry ? formatExpiry(data.tokenExpiry, data.minutesLeft) : '-';
            document.getElementById('detailSubType').textContent = subName;
            document.getElementById('detailOverageRate').textContent = data.overageRate || '$0.04/INVOCATIONS';
            document.getElementById('detailResourceType').textContent = data.resourceType || 'CREDIT';
            document.getElementById('detailCanUpgrade').textContent = data.canUpgrade ? 'æ˜¯' : 'å¦';
            // æ¨¡å‹
            renderDetailModels(data.models || []);
        }

        function formatExpiry(expiry, minutesLeft) {
            const date = new Date(expiry);
            const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            return `${timeStr} (${minutesLeft || 0}åˆ†é’Ÿå)`;
        }

        function renderDetailModels(models) {
            const grid = document.getElementById('detailModelsGrid');
            document.getElementById('detailModelCount').textContent = models.length + ' ä¸ªæ¨¡å‹';
            if (!models || models.length === 0) {
                grid.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-4">æš‚æ— å¯ç”¨æ¨¡å‹</div>';
                return;
            }
            grid.innerHTML = models.map(m => `
                <div class="model-card bg-gray-50 rounded-lg p-3 border hover:border-blue-300">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-medium text-gray-800">${m.name}</span>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">${m.credit}x</span>
                    </div>
                    <div class="text-xs text-gray-500">${m.description || ''}</div>
                    <div class="text-xs text-gray-400 mt-1 font-mono">${m.id}</div>
                </div>
            `).join('');
        }

        // ========== Chat åŠŸèƒ½ ==========
        async function loadModels() {
            try {
                const resp = await fetch('/api/models');
                const data = await resp.json();
                const select = document.getElementById('modelSelect');
                select.innerHTML = (data.models || []).map(m => `<option value="${m.id}">${m.name} (${m.credit}x)</option>`).join('');
            } catch (e) { console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', e); }
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            const model = document.getElementById('modelSelect').value;
            const stream = document.getElementById('streamMode').checked;
            chatHistory.push({ role: 'user', content: msg });
            appendChatMessage('user', msg);
            if (stream) {
                await sendStreamChat(model);
            } else {
                await sendNonStreamChat(model);
            }
        }

        async function sendStreamChat(model) {
            const msgDiv = appendChatMessage('assistant', '');
            const contentSpan = msgDiv.querySelector('.content');
            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: chatHistory, stream: true, model })
                });
                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            try {
                                const json = JSON.parse(data);
                                if (json.content) { fullContent += json.content; contentSpan.textContent = fullContent; }
                            } catch (e) {}
                        }
                    }
                }
                chatHistory.push({ role: 'assistant', content: fullContent });
            } catch (e) { contentSpan.textContent = 'è¯·æ±‚å¤±è´¥: ' + e.message; }
        }

        async function sendNonStreamChat(model) {
            const msgDiv = appendChatMessage('assistant', 'æ€è€ƒä¸­...');
            const contentSpan = msgDiv.querySelector('.content');
            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: chatHistory, stream: false, model })
                });
                const data = await resp.json();
                if (data.error) { contentSpan.textContent = 'é”™è¯¯: ' + data.error; return; }
                contentSpan.textContent = data.content;
                chatHistory.push({ role: 'assistant', content: data.content });
            } catch (e) { contentSpan.textContent = 'è¯·æ±‚å¤±è´¥: ' + e.message; }
        }

        function appendChatMessage(role, content) {
            const container = document.getElementById('chatMessages');
            if (container.querySelector('.text-center')) container.innerHTML = '';
            const div = document.createElement('div');
            div.className = `message p-3 rounded-lg ${role === 'user' ? 'bg-blue-100 ml-12' : 'bg-gray-100 mr-12'}`;
            div.innerHTML = `<div class="text-xs text-gray-500 mb-1">${role === 'user' ? 'ä½ ' : 'AI'}</div><div class="content text-gray-800 whitespace-pre-wrap">${content}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        function clearChat() { chatHistory = []; document.getElementById('chatMessages').innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-comment-dots text-4xl mb-2"></i><p>å¼€å§‹å¯¹è¯å§ï¼</p></div>'; }

        // ========== æœç´¢åŠŸèƒ½ ==========
        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) { showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error'); return; }
            const maxResults = parseInt(document.getElementById('maxResults').value) || 10;
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">æœç´¢ä¸­...</p></div>';
            try {
                const resp = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, maxResults })
                });
                const data = await resp.json();
                if (data.error) { resultsDiv.innerHTML = `<div class="text-center text-red-500 py-8">${data.error}</div>`; return; }
                if (!data.results || data.results.length === 0) { resultsDiv.innerHTML = '<div class="text-center text-gray-500 py-8">æœªæ‰¾åˆ°ç»“æœ</div>'; return; }
                resultsDiv.innerHTML = data.results.map(r => `
                    <div class="p-4 bg-gray-50 rounded-lg border hover:border-blue-300 transition">
                        <a href="${r.url}" target="_blank" class="text-blue-600 hover:underline font-medium">${r.title}</a>
                        <p class="text-sm text-gray-600 mt-1">${r.snippet}</p>
                        <div class="text-xs text-gray-400 mt-2">${r.domain} ${r.publishedDate ? 'Â· ' + new Date(r.publishedDate).toLocaleDateString() : ''}</div>
                    </div>
                `).join('');
            } catch (e) { resultsDiv.innerHTML = `<div class="text-center text-red-500 py-8">æœç´¢å¤±è´¥: ${e.message}</div>`; }
        }

        // ========== MCP å·¥å…· ==========
        async function loadTools() {
            const listDiv = document.getElementById('toolsList');
            listDiv.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div></div>';
            try {
                const resp = await fetch('/api/tools');
                const data = await resp.json();
                if (data.error) { listDiv.innerHTML = `<div class="text-center text-red-500 py-4">${data.error}</div>`; return; }
                if (!data.tools || data.tools.length === 0) { listDiv.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— å¯ç”¨å·¥å…·</div>'; return; }
                listDiv.innerHTML = data.tools.map(t => `
                    <div class="p-3 bg-gray-50 rounded-lg border hover:border-blue-300 cursor-pointer transition" onclick="selectTool('${t.name}', ${JSON.stringify(JSON.stringify(t.inputSchema))})">
                        <div class="font-medium text-gray-800">${t.name}</div>
                        <div class="text-sm text-gray-500">${t.description}</div>
                    </div>
                `).join('');
            } catch (e) { listDiv.innerHTML = `<div class="text-center text-red-500 py-4">åŠ è½½å¤±è´¥: ${e.message}</div>`; }
        }

        function selectTool(name, schema) {
            document.getElementById('toolName').value = name;
            document.getElementById('toolArgs').value = JSON.stringify(JSON.parse(schema).properties ? Object.fromEntries(Object.keys(JSON.parse(schema).properties).map(k => [k, ''])) : {}, null, 2);
            document.getElementById('toolCallSection').classList.remove('hidden');
            document.getElementById('toolResult').classList.add('hidden');
        }

        async function callTool() {
            const name = document.getElementById('toolName').value;
            let args = {};
            try { args = JSON.parse(document.getElementById('toolArgs').value || '{}'); } catch (e) { showToast('å‚æ•° JSON æ ¼å¼é”™è¯¯', 'error'); return; }
            const resultDiv = document.getElementById('toolResult');
            const contentPre = document.getElementById('toolResultContent');
            resultDiv.classList.remove('hidden');
            contentPre.textContent = 'æ‰§è¡Œä¸­...';
            try {
                const resp = await fetch('/api/tools/call', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, arguments: args })
                });
                const data = await resp.json();
                if (data.error) { contentPre.textContent = 'é”™è¯¯: ' + data.error; return; }
                contentPre.textContent = JSON.stringify(data.content, null, 2);
            } catch (e) { contentPre.textContent = 'æ‰§è¡Œå¤±è´¥: ' + e.message; }
        }

        // ========== æ¨¡å‹æ˜ å°„ ==========
        let currentMapping = {};
        let currentMappingHash = '';

        async function loadModelMapping(showMsg = false) {
            try {
                const resp = await fetch('/api/model-mapping');
                const data = await resp.json();
                currentMapping = data.mapping || {};
                currentMappingHash = data.hash || '';
                renderMappingTable();
                if (showMsg) showToast('é…ç½®å·²åŠ è½½', 'success');
            } catch (e) { showToast('åŠ è½½å¤±è´¥: ' + e.message, 'error'); }
        }

        function renderMappingTable() {
            const table = document.getElementById('mappingTable');
            const entries = Object.entries(currentMapping);
            if (entries.length === 0) { table.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— æ˜ å°„é…ç½®</div>'; return; }
            table.innerHTML = entries.map(([from, to], i) => `
                <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                    <input type="text" value="${from}" class="flex-1 px-3 py-2 border rounded text-sm" data-index="${i}" data-field="from">
                    <i class="fas fa-arrow-right text-gray-400"></i>
                    <input type="text" value="${to}" class="flex-1 px-3 py-2 border rounded text-sm" data-index="${i}" data-field="to">
                    <button onclick="removeMappingRow(${i})" class="p-2 text-red-600 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function addMappingRow() {
            currentMapping['new-model-id'] = 'claude-sonnet-4.5';
            renderMappingTable();
        }

        function removeMappingRow(index) {
            const keys = Object.keys(currentMapping);
            if (keys[index]) { delete currentMapping[keys[index]]; renderMappingTable(); }
        }

        async function saveModelMapping() {
            const inputs = document.querySelectorAll('#mappingTable input');
            const newMapping = {};
            for (let i = 0; i < inputs.length; i += 2) {
                const from = inputs[i].value.trim();
                const to = inputs[i + 1].value.trim();
                if (from && to) newMapping[from] = to;
            }
            try {
                const resp = await fetch('/api/model-mapping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mapping: newMapping, hash: currentMappingHash })
                });
                const data = await resp.json();
                if (resp.status === 409) {
                    showToast(data.error || 'é…ç½®å·²è¢«ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•', 'error');
                    return;
                }
                if (data.error) { showToast(data.error, 'error'); return; }
                currentMapping = newMapping;
                currentMappingHash = data.hash || '';
                showToast('é…ç½®å·²ä¿å­˜', 'success');
            } catch (e) { showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error'); }
        }

        // ========== API-KEY è®¾ç½® ==========
        let currentApiKeys = [];
        let currentApiKeysHash = '';

        async function loadApiKeysConfig(showMsg = false) {
            try {
                const resp = await fetch('/api/settings/api-keys');
                const data = await resp.json();
                currentApiKeys = (data.keys || []).map(k => k.full);
                currentApiKeysHash = data.hash || '';
                renderApiKeysTable();
                if (showMsg) showToast(`å·²åŠ è½½ ${data.count} ä¸ª API-KEY`, 'success');
            } catch (e) { showToast('åŠ è½½å¤±è´¥: ' + e.message, 'error'); }
        }

        function renderApiKeysTable() {
            const table = document.getElementById('apiKeysTable');
            if (currentApiKeys.length === 0) {
                table.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-unlock text-2xl mb-2"></i><p>æœªé…ç½® API-KEYï¼Œæ‰€æœ‰è¯·æ±‚æ— éœ€è®¤è¯</p></div>';
                return;
            }
            table.innerHTML = currentApiKeys.map((key, i) => `
                <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded border">
                    <span class="text-gray-500 text-sm w-8">#${i + 1}</span>
                    <input type="text" value="${key}" class="flex-1 px-3 py-2 border rounded text-sm font-mono api-key-input" data-index="${i}">
                    <button onclick="copyApiKey(${i})" class="p-2 text-blue-600 hover:bg-blue-50 rounded" title="å¤åˆ¶"><i class="fas fa-copy"></i></button>
                    <button onclick="removeApiKeyRow(${i})" class="p-2 text-red-600 hover:bg-red-50 rounded" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function addApiKeyRow() {
            currentApiKeys.push('sk-');
            renderApiKeysTable();
            // èšç„¦åˆ°æ–°æ·»åŠ çš„è¾“å…¥æ¡†
            setTimeout(() => {
                const inputs = document.querySelectorAll('.api-key-input');
                if (inputs.length > 0) inputs[inputs.length - 1].focus();
            }, 100);
        }

        function removeApiKeyRow(index) {
            currentApiKeys.splice(index, 1);
            renderApiKeysTable();
        }

        function copyApiKey(index) {
            const key = currentApiKeys[index];
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(key).then(() => {
                    showToast('API-KEY å·²å¤åˆ¶', 'success');
                }).catch(() => { fallbackCopy(key, 'API-KEY å·²å¤åˆ¶'); });
            } else {
                fallbackCopy(key, 'API-KEY å·²å¤åˆ¶');
            }
        }

        function generateApiKey() {
            // ç”Ÿæˆéšæœº API-KEY: sk- + 48ä½éšæœºå­—ç¬¦
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let key = 'sk-';
            for (let i = 0; i < 48; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            currentApiKeys.push(key);
            renderApiKeysTable();
            showToast('å·²ç”Ÿæˆæ–°çš„ API-KEY', 'success');
        }

        async function saveApiKeysConfig() {
            // ä»è¾“å…¥æ¡†è·å–æœ€æ–°å€¼
            const inputs = document.querySelectorAll('.api-key-input');
            const keys = Array.from(inputs).map(input => input.value.trim()).filter(k => k);
            try {
                const resp = await fetch('/api/settings/api-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keys, hash: currentApiKeysHash })
                });
                const data = await resp.json();
                if (resp.status === 409) {
                    showToast(data.error || 'é…ç½®å·²è¢«ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•', 'error');
                    return;
                }
                if (data.error) { showToast(data.error, 'error'); return; }
                currentApiKeys = keys;
                currentApiKeysHash = data.hash || '';
                showToast(`é…ç½®å·²ä¿å­˜ï¼Œå…± ${data.count} ä¸ª API-KEY`, 'success');
            } catch (e) { showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error'); }
        }

        // ========== é™æµé…ç½® ==========
        async function loadRateLimitConfig() {
            try {
                const resp = await fetch('/api/settings/rate-limit');
                const data = await resp.json();
                document.getElementById('rateLimitEnabled').checked = data.enabled;
                document.getElementById('rateLimitRpm').value = data.requestsPerMin || 60;
                document.getElementById('rateLimitPenalty').value = data.penaltySeconds || 0;
            } catch (e) { console.error('åŠ è½½é™æµé…ç½®å¤±è´¥:', e); }
        }

        async function saveRateLimitConfig() {
            const enabled = document.getElementById('rateLimitEnabled').checked;
            const rpm = parseInt(document.getElementById('rateLimitRpm').value) || 60;
            const penalty = parseInt(document.getElementById('rateLimitPenalty').value) || 0;
            try {
                const resp = await fetch('/api/settings/rate-limit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled, requestsPerMin: rpm, penaltySeconds: penalty })
                });
                const data = await resp.json();
                if (data.error) { showToast(data.error, 'error'); return; }
                showToast('é™æµé…ç½®å·²ä¿å­˜', 'success');
            } catch (e) { showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error'); }
        }

        // ========== IP é»‘åå• ==========
        let currentIpBlacklist = [];
        let currentIpBlacklistHash = '';

        async function loadIpBlacklist(showMsg = false) {
            try {
                const resp = await fetch('/api/settings/ip-blacklist');
                const data = await resp.json();
                currentIpBlacklist = data.ips || [];
                currentIpBlacklistHash = data.hash || '';
                renderIpBlacklistTable();
                if (showMsg) showToast(`å·²åŠ è½½ ${data.count} ä¸ªé»‘åå• IP`, 'success');
            } catch (e) { showToast('åŠ è½½å¤±è´¥: ' + e.message, 'error'); }
        }

        function renderIpBlacklistTable() {
            const table = document.getElementById('ipBlacklistTable');
            if (currentIpBlacklist.length === 0) {
                table.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-check-circle text-2xl mb-2"></i><p>é»‘åå•ä¸ºç©º</p></div>';
                return;
            }
            table.innerHTML = currentIpBlacklist.map((ip, i) => `
                <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded border">
                    <span class="text-gray-500 text-sm w-8">#${i + 1}</span>
                    <input type="text" value="${ip}" class="flex-1 px-3 py-2 border rounded text-sm font-mono ip-input" data-index="${i}">
                    <button onclick="removeIpRow(${i})" class="p-2 text-red-600 hover:bg-red-50 rounded" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function addIpRow() {
            currentIpBlacklist.push('');
            renderIpBlacklistTable();
            setTimeout(() => {
                const inputs = document.querySelectorAll('.ip-input');
                if (inputs.length > 0) inputs[inputs.length - 1].focus();
            }, 100);
        }

        function removeIpRow(index) {
            currentIpBlacklist.splice(index, 1);
            renderIpBlacklistTable();
        }

        async function saveIpBlacklist() {
            const inputs = document.querySelectorAll('.ip-input');
            const ips = Array.from(inputs).map(input => input.value.trim()).filter(ip => ip);
            try {
                const resp = await fetch('/api/settings/ip-blacklist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ips, hash: currentIpBlacklistHash })
                });
                const data = await resp.json();
                if (resp.status === 409) {
                    showToast(data.error || 'é…ç½®å·²è¢«ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•', 'error');
                    return;
                }
                if (data.error) { showToast(data.error, 'error'); return; }
                currentIpBlacklist = ips;
                currentIpBlacklistHash = data.hash || '';
                showToast(`é»‘åå•å·²ä¿å­˜ï¼Œå…± ${data.count} ä¸ª IP`, 'success');
            } catch (e) { showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error'); }
        }

        // ========== ç³»ç»Ÿé€šçŸ¥é…ç½® ==========
        async function loadNotificationConfig(showMsg = false) {
            try {
                const resp = await fetch('/api/notification');
                const data = await resp.json();
                document.getElementById('notificationEnabled').checked = data.enabled || false;
                document.getElementById('notificationMessage').value = data.message || '';
                if (showMsg) showToast('é€šçŸ¥é…ç½®å·²åŠ è½½', 'success');
            } catch (e) { showToast('åŠ è½½é€šçŸ¥é…ç½®å¤±è´¥: ' + e.message, 'error'); }
        }

        async function saveNotificationConfig() {
            try {
                const enabled = document.getElementById('notificationEnabled').checked;
                const message = document.getElementById('notificationMessage').value;
                const resp = await fetch('/api/notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled, message })
                });
                const data = await resp.json();
                if (data.error) { showToast(data.error, 'error'); return; }
                showToast('é€šçŸ¥é…ç½®å·²ä¿å­˜', 'success');
            } catch (e) { showToast('ä¿å­˜é€šçŸ¥é…ç½®å¤±è´¥: ' + e.message, 'error'); }
        }

        // ========== è´¦å·ç»Ÿè®¡å›¾è¡¨ ==========
        const chartColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16'];

        async function loadAccountStats() {
            try {
                const resp = await fetch('/api/stats/accounts');
                const data = await resp.json();
                // æ›´æ–°æ ‡é¢˜ä¸­çš„æ€»è°ƒç”¨æ¬¡æ•°
                const totalCount = data.totalRequests || 0;
                document.getElementById('totalRequestsCount').textContent = `ï¼ˆ${totalCount}ï¼‰`;
                renderRequestPieChart(data.accounts || [], totalCount);
                renderRequestRankList(data.accounts || [], totalCount);
                renderAccountErrorList(data.accounts || []);
                showToast('ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°', 'success');
            } catch (e) {
                showToast('åŠ è½½ç»Ÿè®¡å¤±è´¥: ' + e.message, 'error');
            }
        }

        function renderRequestPieChart(accounts, total) {
            const container = document.getElementById('requestPieChart');
            if (!accounts || accounts.length === 0 || total === 0) {
                container.innerHTML = '<div class="text-gray-500">æš‚æ— æ•°æ®</div>';
                return;
            }
            // ç®€å•çš„ CSS é¥¼å›¾
            let html = '<div class="flex items-center space-x-4">';
            html += '<div class="relative w-40 h-40">';
            let cumPercent = 0;
            const gradients = accounts.map((acc, i) => {
                const color = chartColors[i % chartColors.length];
                const start = cumPercent;
                cumPercent += acc.percent;
                return `${color} ${start}% ${cumPercent}%`;
            }).join(', ');
            html += `<div class="w-full h-full rounded-full" style="background: conic-gradient(${gradients})"></div>`;
            html += '</div>';
            html += '<div class="flex-1 space-y-1 max-h-40 overflow-y-auto">';
            accounts.forEach((acc, i) => {
                const color = chartColors[i % chartColors.length];
                // ä¼˜å…ˆæ˜¾ç¤ºé‚®ç®±ï¼Œæ²¡æœ‰åˆ™æ˜¾ç¤º ID å‰ 8 ä½
                const displayName = acc.email || acc.accountId.substring(0, 8);
                html += `<div class="flex items-center text-sm">
                    <span class="w-3 h-3 rounded-full mr-2" style="background:${color}"></span>
                    <span class="text-gray-600 truncate max-w-32" title="${acc.email || acc.accountId}">${displayName}</span>
                    <span class="ml-auto font-medium">${acc.percent.toFixed(1)}%</span>
                </div>`;
            });
            html += '</div></div>';
            container.innerHTML = html;
        }

        function renderRequestRankList(accounts, total) {
            const container = document.getElementById('requestRankList');
            if (!accounts || accounts.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">æš‚æ— æ•°æ®</div>';
                return;
            }
            // æŒ‰è¯·æ±‚æ•°æ’åº
            const sorted = [...accounts].sort((a, b) => b.requestCount - a.requestCount);
            let html = '';
            sorted.forEach((acc, i) => {
                // ä¼˜å…ˆæ˜¾ç¤ºé‚®ç®±ï¼Œæ²¡æœ‰åˆ™æ˜¾ç¤º ID å‰ 8 ä½
                const displayName = acc.email || acc.accountId.substring(0, 8);
                const barWidth = total > 0 ? (acc.requestCount / total * 100) : 0;
                const color = chartColors[i % chartColors.length];
                html += `<div class="flex items-center space-x-3">
                    <span class="w-6 text-center font-bold text-gray-400">#${i + 1}</span>
                    <span class="w-32 text-sm text-gray-600 truncate" title="${acc.email || acc.accountId}">${displayName}</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div class="h-full rounded-full transition-all" style="width:${barWidth}%;background:${color}"></div>
                    </div>
                    <span class="w-16 text-right text-sm font-medium">${acc.requestCount}</span>
                </div>`;
            });
            container.innerHTML = html;
        }

        function renderAccountErrorList(accounts) {
            const container = document.getElementById('accountErrorList');
            if (!accounts || accounts.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">æš‚æ— æ•°æ®</div>';
                return;
            }
            // æŒ‰æˆåŠŸç‡æ’åºï¼ˆæˆåŠŸç‡é«˜çš„åœ¨ä¸Šé¢ï¼‰
            const sorted = [...accounts].sort((a, b) => {
                const rateA = a.requestCount > 0 ? (a.successCount / a.requestCount * 100) : 0;
                const rateB = b.requestCount > 0 ? (b.successCount / b.requestCount * 100) : 0;
                return rateB - rateA; // é™åºæ’åˆ—ï¼ŒæˆåŠŸç‡é«˜çš„åœ¨å‰
            });
            let html = '';
            sorted.forEach((acc, i) => {
                // ä¼˜å…ˆæ˜¾ç¤ºé‚®ç®±ï¼Œæ²¡æœ‰åˆ™æ˜¾ç¤º ID å‰ 8 ä½
                const displayName = acc.email || acc.accountId.substring(0, 8);
                const successRate = acc.requestCount > 0 ? (acc.successCount / acc.requestCount * 100).toFixed(1) : 0;
                const statusCodes = acc.statusCodes || {};
                const errors = acc.errors || {};
                html += `<div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 rounded-full" style="background:${chartColors[i % chartColors.length]}"></span>
                            <span class="font-medium truncate max-w-48" title="${acc.email || acc.accountId}">${displayName}</span>
                        </div>
                        <div class="flex items-center space-x-4 text-sm">
                            <span class="text-green-600"><i class="fas fa-check mr-1"></i>${acc.successCount || 0}</span>
                            <span class="text-red-600"><i class="fas fa-times mr-1"></i>${acc.failCount || 0}</span>
                            <span class="text-gray-600">æˆåŠŸç‡ ${successRate}%</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-gray-500 mb-2">çŠ¶æ€ç åˆ†å¸ƒ</div>
                            <div class="flex flex-wrap gap-2">
                                ${Object.entries(statusCodes).map(([code, count]) => {
                                    const color = code.startsWith('2') ? 'bg-green-100 text-green-700' : 
                                                  code.startsWith('4') ? 'bg-yellow-100 text-yellow-700' : 
                                                  'bg-red-100 text-red-700';
                                    return `<span class="px-2 py-1 rounded text-xs ${color}">${code}: ${count}</span>`;
                                }).join('')}
                            </div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-2">é”™è¯¯ç±»å‹</div>
                            <div class="space-y-1 max-h-20 overflow-y-auto">
                                ${Object.keys(errors).length === 0 ? '<span class="text-xs text-gray-400">æ— é”™è¯¯</span>' :
                                  Object.entries(errors).map(([err, count]) => {
                                    const shortErr = err.length > 30 ? err.substring(0, 30) + '...' : err;
                                    return `<div class="text-xs text-red-600 truncate" title="${err}">${shortErr}: ${count}</div>`;
                                  }).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // ========== ç†”æ–­ç®¡ç† ==========
        let cbAutoRefreshTimer = null;

        // åŠ è½½ç†”æ–­çŠ¶æ€å¹¶æ¸²æŸ“å¡ç‰‡
        async function loadCircuitBreakerStatus() {
            const container = document.getElementById('circuit-breaker-cards');
            try {
                const resp = await fetch('/api/circuit-breaker/status');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();
                const accounts = data.accounts || [];
                if (accounts.length === 0) {
                    container.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-8"><i class="fas fa-shield-alt text-4xl mb-2"></i><p>æš‚æ— è´¦å·æ•°æ®</p></div>';
                    return;
                }
                // æŒ‰è´¦å·åç§°æ’åºï¼ˆ0-9ï¼ŒA-Zï¼‰
                const sorted = [...accounts].sort((a, b) => {
                    const nameA = (a.email || a.accountId).toLowerCase();
                    const nameB = (b.email || b.accountId).toLowerCase();
                    return nameA.localeCompare(nameB, 'en', { numeric: true });
                });
                container.innerHTML = sorted.map(acc => {
                    // çŠ¶æ€åˆ° CSS ç±»çš„æ˜ å°„
                    const stateClass = acc.state === 'open' ? 'cb-status-open' : acc.state === 'half_open' ? 'cb-status-half-open' : 'cb-status-closed';
                    // æ“ä½œæŒ‰é’®ï¼šæ ¹æ®çŠ¶æ€å†³å®šä¸»è¦æ“ä½œ
                    let actionButtons = '';
                    if (acc.state === 'open') {
                        actionButtons = `<button onclick="resetAccount('${acc.accountId}')" class="flex-1 px-3 py-1.5 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition"><i class="fas fa-unlock mr-1"></i>è§£é™¤ç†”æ–­</button>
                            <button onclick="tripAccount('${acc.accountId}')" class="px-3 py-1.5 border border-red-300 text-red-500 text-sm rounded hover:bg-red-50 transition"><i class="fas fa-ban mr-1"></i>ç†”æ–­</button>`;
                    } else {
                        actionButtons = `<button onclick="tripAccount('${acc.accountId}')" class="flex-1 px-3 py-1.5 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition"><i class="fas fa-ban mr-1"></i>ç†”æ–­</button>
                            <button onclick="resetAccount('${acc.accountId}')" class="px-3 py-1.5 border border-green-300 text-green-500 text-sm rounded hover:bg-green-50 transition"><i class="fas fa-unlock mr-1"></i>è§£é™¤ç†”æ–­</button>`;
                    }
                    // æ„å»ºæƒé‡å’Œè´Ÿè½½æ¯”ä¾‹çš„tooltipè¯´æ˜
                    const weightTooltip = `æƒé‡è®¡ç®—ï¼š(1 - å·²ç”¨é¢åº¦/æ€»é¢åº¦) Ã— 100\nå‰©ä½™é¢åº¦è¶Šå¤šï¼Œæƒé‡è¶Šé«˜ï¼ˆ0-100ï¼‰\nå½“å‰æƒé‡ï¼š${acc.weight}`;
                    const loadTooltip = `è´Ÿè½½æ¯”ä¾‹ = (è´¦å·æƒé‡ / æ‰€æœ‰è´¦å·æƒé‡ä¹‹å’Œ) Ã— 100%\nè¡¨ç¤ºè¯¥è´¦å·åœ¨è´Ÿè½½å‡è¡¡ä¸­è¢«é€‰ä¸­çš„æ¦‚ç‡\nå½“å‰æ¯”ä¾‹ï¼š${acc.loadPercent.toFixed(1)}%`;
                    
                    return `<div class="bg-white border rounded-lg p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-medium text-gray-800">${acc.email || acc.accountId}</span>
                            <span class="px-2 py-1 rounded text-sm font-medium ${stateClass}">${acc.stateLabel}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-3">
                            <div>1åˆ†é’Ÿé”™è¯¯ç‡: <span class="font-medium">${acc.errorRate1m.toFixed(1)}%</span></div>
                            <div>5åˆ†é’Ÿé”™è¯¯ç‡: <span class="font-medium">${acc.errorRate5m.toFixed(1)}%</span></div>
                            <div class="cursor-help" title="${loadTooltip}">è´Ÿè½½æ¯”ä¾‹: <span class="font-medium">${acc.loadPercent.toFixed(1)}%</span> <i class="fas fa-question-circle text-gray-400 text-xs"></i></div>
                            <div class="cursor-help" title="${weightTooltip}">æƒé‡: <span class="font-medium">${acc.weight}</span> <i class="fas fa-question-circle text-gray-400 text-xs"></i></div>
                        </div>
                        <div class="flex gap-2">
                            ${actionButtons}
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                // åŠ è½½å¤±è´¥ï¼šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œä¿ç•™ä¸Šæ¬¡æ•°æ®
                showToast('åŠ è½½ç†”æ–­çŠ¶æ€å¤±è´¥: ' + e.message, 'error');
            }
        }

        // æ‰‹åŠ¨ç†”æ–­
        async function tripAccount(accountId) {
            try {
                const resp = await fetch('/api/circuit-breaker/trip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountId })
                });
                const data = await resp.json();
                if (!resp.ok) {
                    showToast(data.error || 'ç†”æ–­æ“ä½œå¤±è´¥', 'error');
                    return;
                }
                showToast(data.message || 'å·²ç†”æ–­', 'success');
                loadCircuitBreakerStatus();
            } catch (e) {
                showToast('ç†”æ–­æ“ä½œå¤±è´¥: ' + e.message, 'error');
            }
        }

        // è§£é™¤ç†”æ–­
        async function resetAccount(accountId) {
            try {
                const resp = await fetch('/api/circuit-breaker/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountId })
                });
                const data = await resp.json();
                if (!resp.ok) {
                    showToast(data.error || 'è§£é™¤ç†”æ–­å¤±è´¥', 'error');
                    return;
                }
                showToast(data.message || 'å·²è§£é™¤ç†”æ–­', 'success');
                loadCircuitBreakerStatus();
            } catch (e) {
                showToast('è§£é™¤ç†”æ–­å¤±è´¥: ' + e.message, 'error');
            }
        }

        // 10ç§’è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
        function startCBAutoRefresh() {
            stopCBAutoRefresh();
            cbAutoRefreshTimer = setInterval(loadCircuitBreakerStatus, 10000);
        }

        function stopCBAutoRefresh() {
            if (cbAutoRefreshTimer) {
                clearInterval(cbAutoRefreshTimer);
                cbAutoRefreshTimer = null;
            }
        }
    </script>
</body>
</html>
